<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Simulador de Avance</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#121212;color:#eee;margin:0;padding:1rem;}
#controls{margin-bottom:1rem;}
#materias{display:grid;grid-template-columns:repeat(2,minmax(300px,1fr));grid-auto-rows:auto;gap:0.5rem;overflow-x:auto;}
.year{grid-column:1 / -1;display:grid;grid-template-columns:repeat(2,minmax(300px,1fr));gap:0.5rem;}
.year h2{grid-column:1 / -1;}
.cuatrimestre{display:flex;flex-direction:column;gap:0.5rem;}
.card{border:1px solid #444;border-radius:8px;padding:0.5rem;background:#333;cursor:pointer;}
.card.no{background:#444;}
.card.regular{background:#b59f3b;}
.card.aprobada{background:#2e7d32;}
.card.disabled{opacity:0.4;cursor:not-allowed;}
.badges span{margin-right:0.3rem;background:#555;padding:0.1rem 0.3rem;border-radius:4px;font-size:0.8rem;}
@media(max-width:600px){#materias{grid-template-columns:100%;}}
</style>
</head>
<body>
<h1>Simulador de Avance</h1>
<div id="controls">
  <select id="plan"></select>
  <button id="save">Guardar</button>
  <button id="reset">Reiniciar</button>
  <button id="export">Exportar JSON</button>
  <button id="import">Importar JSON</button>
  <input type="file" id="fileInput" style="display:none" />
</div>
<div id="stats"></div>
<div id="materias"></div>
<script>
const STORAGE_KEY='simulador-avance';
let plans={},currentPlan='2023',states={};
fetch('plans.json').then(r=>r.json()).then(data=>{
  plans=data;
  const sel=document.getElementById('plan');
  Object.entries(plans).forEach(([key,plan])=>{
    const opt=document.createElement('option');
    opt.value=key;opt.textContent=plan.nombre;sel.appendChild(opt);
  });
  sel.addEventListener('change',()=>{currentPlan=sel.value;loadStates();render();});
  loadStates();render();
});
function loadStates(){
  const all=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
  states=all[currentPlan]||{};
}
function saveStates(){
  const all=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
  all[currentPlan]=states;
  localStorage.setItem(STORAGE_KEY,JSON.stringify(all));
}
function resetStates(){
  states={};
  saveStates();
  render();
}
function toggleState(code){
  const s=states[code]||0;
  states[code]=(s+1)%3;
  saveStates();
  render();
}
function allowed(code){
  const mat=plans[currentPlan].materias.find(m=>m.codigo===code);
  return mat.correlativas.every(c=>(states[c]||0)==2);
}
function render(){
  const container=document.getElementById('materias');
  container.innerHTML='';
  const grouped={};
  plans[currentPlan].materias.forEach(m=>{
    if(!grouped[m.anio])grouped[m.anio]={1:[],2:[]};
    if(!grouped[m.anio][m.cuatrimestre])grouped[m.anio][m.cuatrimestre]=[];
    grouped[m.anio][m.cuatrimestre].push(m);
  });
  Object.keys(grouped).sort((a,b)=>a-b).forEach(anio=>{
    const yearRow=document.createElement('div');
    yearRow.className='year';
    const h2=document.createElement('h2');
    h2.textContent=`${anio}° Año`;
    yearRow.appendChild(h2);
    [1,2].forEach(cuat=>{
      const cuatDiv=document.createElement('div');
      cuatDiv.className='cuatrimestre';
      const h3=document.createElement('h3');
      h3.textContent=`${cuat}° Cuatrimestre`;
      cuatDiv.appendChild(h3);
      (grouped[anio][cuat]||[]).forEach(m=>{
        const card=document.createElement('div');
        card.className='card';
        const state=states[m.codigo]||0;
        card.classList.add(['no','regular','aprobada'][state]);
        if(!allowed(m.codigo))card.classList.add('disabled');
        card.innerHTML=`<strong>${m.codigo} — ${m.nombre}</strong><div class="badges"><span>${m.regimen}</span><span>${m.carga_horaria}h</span></div>`+(m.correlativas.length?`<div>Correlativas: ${m.correlativas.join(', ')}</div>`:'');
        if(allowed(m.codigo))card.addEventListener('click',()=>toggleState(m.codigo));
        cuatDiv.appendChild(card);
      });
      yearRow.appendChild(cuatDiv);
    });
    container.appendChild(yearRow);
  });
  updateStats();
}
function updateStats(){
  const counts={0:0,1:0,2:0};
  plans[currentPlan].materias.forEach(m=>{counts[states[m.codigo]||0]++;});
  document.getElementById('stats').textContent=`Aprobadas: ${counts[2]} | Regulares: ${counts[1]} | No cursadas: ${counts[0]} | Total: ${plans[currentPlan].materias.length}`;
}
document.getElementById('save').addEventListener('click',saveStates);
document.getElementById('reset').addEventListener('click',resetStates);
document.getElementById('export').addEventListener('click',()=>{
  const data=localStorage.getItem(STORAGE_KEY)||'{}';
  const blob=new Blob([data],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='simulador.json';
  a.click();
});
document.getElementById('import').addEventListener('click',()=>document.getElementById('fileInput').click());
document.getElementById('fileInput').addEventListener('change',e=>{
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      localStorage.setItem(STORAGE_KEY,ev.target.result);
      loadStates();
      render();
    }catch(err){alert('JSON inválido');}
  };
  reader.readAsText(file);
});
</script>
</body>
</html>
