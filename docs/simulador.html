<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulador de Avance</title>

<style>
  :root{
    --bg:#0b0f14; --panel:#0f1625; --border:#1f2a36; --text:#e6edf3; --muted:#9fb0c2;
    --ok:#16a34a; --warn:#f59e0b; --off:#4b5563; --accent:#60a5fa;
    --card:#0e1421; --card2:#121a2b;
  }

  /* Base */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 10% -10%, #10233a 0%, rgba(16,35,58,0) 60%) ,
                radial-gradient(800px 500px at 110% -10%, #1b2a43 0%, rgba(27,42,67,0) 50%) ,
                var(--bg);
    font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
  }

  /* Header / Controls */
  header{
    position:sticky; top:0; z-index:10;
    background:rgba(11,15,20,.7); backdrop-filter:saturate(130%) blur(8px);
    border-bottom:1px solid var(--border);
  }
  .wrap{max-width:1180px;margin:0 auto;padding:18px}
  h1{margin:0 0 10px 0;font-size:1.6rem;letter-spacing:.3px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  select,button{
    background:linear-gradient(180deg,var(--panel),#0c131f);
    border:1px solid var(--border); color:var(--text);
    padding:8px 12px; border-radius:12px; font-weight:600; cursor:pointer
  }
  button.secondary{background:#0b121e}
  button:disabled{opacity:.6;cursor:not-allowed}
  .legend{display:flex;flex-wrap:wrap;gap:14px;align-items:center;margin-left:auto;font-size:.9rem}
  .dot{width:12px;height:12px;border-radius:999px;display:inline-block;margin-right:6px}

  /* Stats */
  #stats{
    margin-top:10px;color:var(--muted);font-size:.95rem
  }

  /* Grid */
  #materias{display:grid;grid-template-columns:repeat(2,minmax(320px,1fr));gap:14px;margin-top:16px}
  .year{grid-column:1 / -1;border:1px solid var(--border);border-radius:16px;padding:14px;background:linear-gradient(180deg,var(--card),var(--card2))}
  .year > h2{margin:0 0 10px 0;font-size:1.2rem;color:#cfe1ff}
  .year-grid{display:grid;grid-template-columns:repeat(2,minmax(300px,1fr));gap:12px}
  .cuat h3{margin:0 0 8px 0;color:#b6c6dc;font-size:1rem}

  /* Cards */
  .card{
    border:1px solid var(--border); border-radius:14px;
    padding:12px; background:linear-gradient(180deg,#0f1726,#0c1422);
    transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease;
    cursor:pointer
  }
  .card:hover{transform:translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.25); border-color:#314359}
  .card.disabled{opacity:.45; cursor:not-allowed; filter:grayscale(.1)}
  .title{font-weight:700;margin-bottom:6px}
  .badges{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .badge{background:#0b1423;border:1px solid #223147;color:#b8c5d8;padding:2px 8px;border-radius:999px;font-size:.75rem}

  /* State colors */
  .no{background:linear-gradient(180deg,#171e2b,#131a27)}
  .regular{background:linear-gradient(180deg,#2b2413,#1f1a0d); border-color:#6b5714}
  .aprobada{background:linear-gradient(180deg,#0e2415,#0a1c10); border-color:#1b6a35}

  /* Footer */
  footer{border-top:1px solid var(--border);padding:16px;color:#97a7bd;text-align:center;margin-top:18px}
  footer a{color:var(--accent);text-decoration:none}

  /* Responsive */
  @media (max-width: 900px){
    #materias{grid-template-columns:1fr}
    .year-grid{grid-template-columns:1fr}
  }

  /* Intro */
  #intro{
    position:fixed; inset:0; display:flex; flex-direction:column;
    align-items:center; justify-content:center; gap:20px;
    background:var(--bg); text-align:center;
  }
  #intro h1{margin:0 0 20px 0;font-size:1.8rem}
  #intro button{font-size:1.1rem; padding:12px 24px}
</style>
</head>

<body>
  <div id="intro">
    <h1>Simulador de Avance</h1>
    <div>
      <button data-plan="2023">Plan 2023</button>
      <button data-plan="2009">Plan 2009</button>
    </div>
  </div>

  <div id="simulator" style="display:none">
  <header>
    <div class="wrap">
      <h1>Simulador de Avance</h1>
      <div class="controls">
        <select id="plan"></select>
        <button id="save">Guardar</button>
        <button id="reset" class="secondary">Reiniciar</button>
        <button id="export">Exportar JSON</button>
        <button id="import" class="secondary">Importar JSON</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none" />
        <div class="legend">
          <span><span class="dot" style="background:var(--off)"></span>No cursada</span>
          <span><span class="dot" style="background:var(--warn)"></span>Regular</span>
          <span><span class="dot" style="background:var(--ok)"></span>Aprobada</span>
        </div>
      </div>
      <div id="stats"></div>
    </div>
  </header>

  <main class="wrap">
    <div id="materias"></div>
  </main>

  <footer class="wrap">Hecho con ❤️ para UNNE LSI • <a href="https://github.com/tobiager/UNNE-LSI" target="_blank" rel="noopener">Ver repo</a></footer>
  </div>

<script>
  const STORAGE_KEY='simulador-avance';
  const PLAN_KEY='simulador-plan';
  let plans={}, currentPlan=localStorage.getItem(PLAN_KEY)||'', states={};

  // Carga de planes y setup
  fetch('plans.json')
    .then(r=>r.json())
    .then(data=>{
      plans=data;
      const sel=document.getElementById('plan');
      Object.entries(plans).forEach(([key,plan])=>{
        const opt=document.createElement('option');
        opt.value=key; opt.textContent=plan.nombre || key;
        sel.appendChild(opt);
      });
      if(currentPlan && plans[currentPlan]){
        sel.value=currentPlan;
        showSim();
        loadStates(); render();
      }
      sel.addEventListener('change',()=>{
        currentPlan=sel.value;
        localStorage.setItem(PLAN_KEY,currentPlan);
        loadStates();render();
      });
      document.querySelectorAll('#intro button').forEach(btn=>{
        btn.addEventListener('click',()=>{
          currentPlan=btn.dataset.plan;
          localStorage.setItem(PLAN_KEY,currentPlan);
          const sel=document.getElementById('plan');
          if(plans[currentPlan]){
            sel.value=currentPlan;
            showSim();
            loadStates(); render();
          }
        });
      });
    })
    .catch(()=>{ document.getElementById('materias').textContent='No se pudo cargar plans.json'; });

  function showSim(){
    document.getElementById('simulator').style.display='';
    const intro=document.getElementById('intro');
    if(intro) intro.remove();
  }

  function loadStates(){
    const all=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
    states=all[currentPlan]||{};
  }
  function saveStates(){
    const all=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
    all[currentPlan]=states;
    localStorage.setItem(STORAGE_KEY,JSON.stringify(all));
  }
  function resetStates(){
    states={}; saveStates(); render();
  }
  function toggleState(code){
    const s=states[code]||0;
    states[code]=(s+1)%3; // 0→1→2→0
    saveStates(); render();
  }
  function allowed(code){
    const mat=(plans[currentPlan].materias||[]).find(m=>m.codigo===code);
    if(!mat) return false;
    return (mat.correlativas||[]).every(c=>(states[c]||0)===2);
  }

  // Render agrupado por Año / Cuatrimestre
  function render(){
    const container=document.getElementById('materias');
    container.innerHTML='';
    const grouped={};
    (plans[currentPlan].materias||[]).forEach(m=>{
      if(!grouped[m.anio]) grouped[m.anio]={1:[],2:[]};
      grouped[m.anio][m.cuatrimestre] = grouped[m.anio][m.cuatrimestre] || [];
      grouped[m.anio][m.cuatrimestre].push(m);
    });

    Object.keys(grouped).map(n=>+n).sort((a,b)=>a-b).forEach(anio=>{
      const box=document.createElement('section');
      box.className='year';
      const h2=document.createElement('h2');
      h2.textContent=`${anio}° Año`;
      box.appendChild(h2);

      const g=document.createElement('div');
      g.className='year-grid';

      [1,2].forEach(cuat=>{
        const col=document.createElement('div');
        col.className='cuat';
        const h3=document.createElement('h3');
        h3.textContent=`${cuat}° Cuatrimestre`;
        col.appendChild(h3);

        (grouped[anio][cuat]||[]).forEach(m=>{
          const card=document.createElement('div');
          const state=states[m.codigo]||0;
          card.className='card ' + (['no','regular','aprobada'][state]);
          if(!allowed(m.codigo)) card.classList.add('disabled');

          card.innerHTML =
            `<div class="title">${m.codigo} — ${m.nombre}</div>` +
            `<div class="badges">
               <span class="badge">Régimen: ${m.regimen}</span>
               <span class="badge">${m.carga_horaria}h</span>
             </div>` +
            (m.correlativas?.length
              ? `<div class="badges" style="margin-top:8px">
                   <span class="badge">Correlativas: ${m.correlativas.join(', ')}</span>
                 </div>`
              : '');

          if(allowed(m.codigo)) card.addEventListener('click',()=>toggleState(m.codigo));
          col.appendChild(card);
        });

        g.appendChild(col);
      });

      box.appendChild(g);
      container.appendChild(box);
    });

    updateStats();
  }

  function updateStats(){
    const counts={0:0,1:0,2:0};
    (plans[currentPlan].materias||[]).forEach(m=>{counts[states[m.codigo]||0]++;});
    document.getElementById('stats').textContent =
      `Aprobadas: ${counts[2]} | Regulares: ${counts[1]} | No cursadas: ${counts[0]} | Total: ${(plans[currentPlan].materias||[]).length}`;
  }

  // Botones
  document.getElementById('save').addEventListener('click',()=>{
    saveStates();
    const btn=document.getElementById('save'); const old=btn.textContent;
    btn.textContent='Guardado ✓'; setTimeout(()=>btn.textContent=old,1200);
  });
  document.getElementById('reset').addEventListener('click',()=>{
    if(confirm('¿Reiniciar estados de este plan?')) resetStates();
  });
  document.getElementById('export').addEventListener('click',()=>{
    const data=localStorage.getItem(STORAGE_KEY)||'{}';
    const blob=new Blob([data],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='simulador.json'; a.click();
  });
  document.getElementById('import').addEventListener('click',()=>document.getElementById('fileInput').click());
  document.getElementById('fileInput').addEventListener('change',e=>{
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        localStorage.setItem(STORAGE_KEY,ev.target.result);
        loadStates(); render();
      }catch{ alert('JSON inválido'); }
    };
    reader.readAsText(file);
  });
</script>
</body>
</html>
