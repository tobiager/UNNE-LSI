
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulador de Avance</title>
<style>
  :root{
    --bg-light:#f3f4f6; --bg-dark:#0b0f14;
    --panel-light:#ffffff; --panel-dark:#0f1625;
    --border-light:#d1d5db; --border-dark:#1f2a36;
    --text-light:#1f2937; --text-dark:#e6edf3;
    --muted-light:#6b7280; --muted-dark:#9fb0c2;
    --card-light:#ffffff; --card-dark:#0f1726;
    --card2-light:#f9fafb; --card2-dark:#0b1423;
    --grad1-light:#ffffff; --grad1-dark:#10233a;
    --grad2-light:#e5e7eb; --grad2-dark:#1b2a43;
    --ok:#16a34a; --warn:#f59e0b; --off:#4b5563; --accent:#60a5fa;
    --footer-h:56px; --status-h:82px;
    /* valores por defecto (oscuro) */
    --bg:var(--bg-dark); --panel:var(--panel-dark); --border:var(--border-dark);
    --text:var(--text-dark); --muted:var(--muted-dark);
    --card:var(--card-dark); --card2:var(--card2-dark);
    --grad1:var(--grad1-dark); --grad2:var(--grad2-dark);
  }
  body.theme-light{--bg:var(--bg-light);--panel:var(--panel-light);--border:var(--border-light);--text:var(--text-light);--muted:var(--muted-light);--card:var(--card-light);--card2:var(--card2-light);--grad1:var(--grad1-light);--grad2:var(--grad2-light)}
  body.theme-dark{--bg:var(--bg-dark);--panel:var(--panel-dark);--border:var(--border-dark);--text:var(--text-dark);--muted:var(--muted-dark);--card:var(--card-dark);--card2:var(--card2-dark);--grad1:var(--grad1-dark);--grad2:var(--grad2-dark)}
  *{box-sizing:border-box}
  body{margin:0;color:var(--text);
    background:
      radial-gradient(900px 360px at -10% -10%,var(--grad1) 0,transparent 60%),
      radial-gradient(700px 480px at 110% -10%,var(--grad2) 0,transparent 50%),
      var(--bg);
    font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
  }
  header{position:sticky;top:0;z-index:10;background:rgba(11,15,20,.7);
    backdrop-filter:saturate(130%) blur(8px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1180px;margin:0 auto;padding:16px}
  h1{margin:0 0 8px;font-size:1.7rem;letter-spacing:.2px}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  select,button,input[type="search"],input[type="text"]{
    background:var(--panel);border:1px solid var(--border);color:var(--text);
    padding:8px 12px;border-radius:12px;font-weight:600
  }
  .legend{display:flex;flex-wrap:wrap;gap:12px;margin-left:auto}
  .toolbar details.menu>summary{
    
list-style:none;cursor:pointer;
background:var(--panel);border:1px solid var(--border);color:var(--text);
padding:8px 12px;border-radius:12px;font-weight:600
}
.toolbar details.menu>.menu-content{flex-wrap:wrap;gap:10px;margin-top:8px}
.toolbar details.menu .legend{margin-left:0}

/* Mobile: show arrow and keep menu cerrado por defecto */
@media (max-width:699px){
  .toolbar details.menu>.menu-content{display:none}
  .toolbar details.menu[open]>.menu-content{display:flex}
  .toolbar select,.toolbar input[type="search"]{flex:1 1 100%}
  .toolbar details.menu{width:100%}
}

/* Desktop: mostrar opciones siempre y ocultar el trigger */
@media (min-width:700px){
  .toolbar details.menu>summary{display:none}
  .toolbar details.menu{display:flex;flex-wrap:wrap;gap:10px}
  .toolbar details.menu>.menu-content{display:flex !important;margin-top:0}
}

  }
  .dot{width:12px;height:12px;border-radius:999px;display:inline-block;margin-right:6px}

  main{padding:10px 0 24px}
  main, body{padding-bottom:calc(var(--status-h) + var(--footer-h) + 24px)}

  #materias{display:grid;grid-template-columns:repeat(2,minmax(320px,1fr));gap:14px;margin-top:16px}
  .year{grid-column:1 / -1;border:1px solid var(--border);border-radius:16px;padding:14px;background:linear-gradient(180deg,var(--card),var(--card2))}
  .year>h2{margin:4px 0 12px;font-size:1.15rem;color:#cfe1ff}
  .year-grid{display:grid;grid-template-columns:repeat(2,minmax(300px,1fr));gap:12px}
  .cuat h3{margin:0 0 8px;color:#b6c6dc;font-size:1rem}

  .card{border:1px solid var(--border);border-radius:14px;padding:12px;background:linear-gradient(180deg,var(--card),var(--card2));transition:transform .12s ease,box-shadow .12s ease;position:relative}
  .card:hover{transform:translateY(-1px);box-shadow:0 8px 16px rgba(0,0,0,.25)}
  .title{font-weight:800;margin:0 0 2px;font-size:1.02rem}
  .sub{color:#c8d7ea;margin:0 0 6px;font-size:.85rem}
  .meta,.reqs{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .chip{background:var(--panel);border:1px solid var(--border);color:var(--text);padding:2px 8px;border-radius:999px;font-size:.73rem}
  .req{padding:2px 8px;border-radius:999px;font-size:.73rem;border:1px solid var(--border)}
  .req.ok{background:#0f2717;border-color:#1e6a39;color:#a7f3d0}
  .req.miss{background:#2a0f12;border-color:#7f1d1d;color:#fecaca}
  .req.unknown{background:#2a1f0f;border-color:#7c2d12;color:#fde68a}
  .state{display:inline-flex;gap:6px;margin-top:10px}
  .btn{border:1px solid var(--border);background:var(--panel);color:var(--text);padding:4px 8px;border-radius:10px;font-size:.8rem;cursor:pointer}
  .btn.active{outline:2px solid var(--accent)}
  .btn.off{background:#30343b}
  .btn.cur{background:#1e3a5f}
  .btn.reg{background:#5e4a16}
  .btn.ok{background:#0f3a20}
  .note{margin-top:8px;width:100%}

  .badge{position:absolute;top:8px;right:8px;padding:2px 8px;border-radius:999px;font-size:.72rem;font-weight:700}
  .no     {border-color:#3b414c}
  .no .badge{background:#3b414c}
  .curso  {border-color:#1e3a5f}
  .curso .badge{background:#1e3a5f}
  .regular{border-color:#b59f3b}
  .regular .badge{background:#b59f3b}
  .aprobada{border-color:#16a34a}
  .aprobada .badge{background:#16a34a}

  .statusbar{
    position:fixed; left:0; right:0; bottom:var(--footer-h);
    z-index:20; background:rgba(11,15,20,.75); backdrop-filter:saturate(130%) blur(8px);
    border-top:1px solid var(--border);
  }
  .statusbar>summary{
    list-style:none;cursor:pointer;
    display:flex;align-items:center;justify-content:center;
    color:var(--muted);padding:4px 0;
  }
  .statusbar>summary::-webkit-details-marker{display:none}
  .statusbar[open]>summary::after{content:'\25BC'}
  .statusbar:not([open])>summary::after{content:'\25B2'}
  .status-inner{max-width:1180px;margin:0 auto;padding:10px 16px;display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .statusbar:not([open]) .status-inner{display:none}
  /* Desktop: barra de estado siempre visible */
  @media (min-width:700px){
    .statusbar>summary{display:none}
    .statusbar .status-inner{display:flex !important}
  }
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--panel);font-weight:700;font-size:.82rem}
  .pill.green{border-color:#1f6d3c;background:#0f2717;color:#9df2c9}
  .pill.yellow{border-color:#8b6a1b;background:#2a220d;color:#fde68a}
  .pill.gray{border-color:#3b414c;background:#161a22;color:#cbd5e1}
  .pill.dark{border-color:#2b3644;background:#0f1522;color:#cfe1ff}
  .pill.blue{border-color:#1e3a5f;background:#10223b;color:#bfdbfe}

  .bar{flex:1;display:flex;align-items:center;gap:10px;min-width:280px}
  .meter{height:10px;border-radius:999px;background:var(--panel);border:1px solid var(--border);overflow:hidden;flex:1}
  .meter>span{display:block;height:100%;width:0%}
  .m-green{background:linear-gradient(90deg,#22c55e,#16a34a)}
  .m-blue{background:linear-gradient(90deg,#60a5fa,#3b82f6)}
  .pct{min-width:3.5ch;text-align:right;color:#a7f3d0;font-weight:800}

  footer{
    position:fixed; left:0; right:0; bottom:0; height:var(--footer-h);
    z-index:19;
    background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(11,15,20,.95));
    backdrop-filter:saturate(140%) blur(8px);
    border-top:1px solid var(--border);
    box-shadow:0 -2px 6px rgba(0,0,0,.4);
    color:var(--muted);
  }
  .footer-inner{
    max-width:1180px;margin:0 auto;height:100%;
    display:flex;align-items:center;justify-content:center;
    gap:8px;flex-wrap:nowrap;white-space:nowrap;overflow-x:auto;
    padding:0 24px;text-align:center;
  }
  @media (max-width:600px){
    .footer-inner{font-size:0.75rem;}
  }
  .gh-link{
    display:inline-flex;align-items:center;gap:6px;
    color:#3b82f6;font-weight:600;text-decoration:none;
  }
  .gh-link:hover{text-decoration:underline}
  .gh-link svg{width:18px;height:18px;fill:currentColor}

  /* Oculta el icono en el enlace del repo */
  .gh-link.no-icon .gh-icon{ display:none; }

  a{color:#9cc9ff;text-decoration:none}
  a:hover{text-decoration:underline}

  .toast{
    position:fixed;left:50%;bottom:calc(var(--footer-h) + 16px);
    transform:translateX(-50%) translateY(100%);
    background:rgba(15,23,42,.95);
    border:1px solid var(--border);color:var(--text);
    padding:12px 20px;border-radius:12px;z-index:999;
    opacity:0;transition:transform .3s ease,opacity .3s ease;
  }
  .toast.show{transform:translateX(-50%) translateY(0);opacity:1;}

  .confirm{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.6);opacity:0;pointer-events:none;transition:opacity .3s;
    z-index:1000;
  }
  .confirm.show{opacity:1;pointer-events:auto;}
  .confirm-box{background:var(--panel);padding:20px;border-radius:12px;max-width:90%;color:var(--text);} 
  .confirm-buttons{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;}
  .confirm-buttons button{background:#0e1727;border:1px solid var(--border);color:var(--text);padding:6px 12px;border-radius:8px;font-weight:600;}

  @media (max-width:900px){
    #materias{grid-template-columns:1fr}
    .year-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Simulador de Avance</h1>
    <div class="toolbar">
      <select id="plan"></select>
      <input id="studentName" placeholder="Tu nombre">
      <input id="search" type="search" placeholder="Buscar materia..." />
      <details id="menu" class="menu">
        <summary>Opciones</summary>
        <div class="menu-content">
          <label><input type="checkbox" id="onlyEnabled"> Solo habilitadas</label>
          <button id="save">Guardar</button>
          <button id="reset">Reiniciar</button>
          <button id="export">Exportar JSON</button>
          <button id="import">Importar JSON</button>
          <button id="share">Link de estado</button>
          <button id="badgeYear">Copiar badge · Año</button>
          <button id="badgePct">Copiar badge · %</button>
          <button id="themeToggle">Tema</button>
          <input type="file" id="fileInput" accept="application/json" style="display:none" />
          <div class="legend">
            <span class="pill gray">No cursada</span>
            <span class="pill blue">En curso</span>
            <span class="pill yellow">Regular</span>
            <span class="pill green">Aprobada</span>
          </div>
        </div>
      </details>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="materias"></div>
</main>

<details id="statusbar" class="statusbar">
  <summary></summary>
  <div class="status-inner">
    <div class="pill green">Aprobadas: <span id="cAprob">0</span></div>
    <div class="pill yellow">Regulares: <span id="cReg">0</span></div>
    <div class="pill blue">En curso: <span id="cCur">0</span></div>
    <div class="pill gray">No cursadas: <span id="cNo">0</span></div>
    <div class="pill dark">Total: <span id="cTot">0</span></div>

    <div class="bar" title="Avance Analista (años 1–3)">
      <span style="white-space:nowrap;color:#9fb0c2">Analista</span>
      <div class="meter"><span id="mAnalista" class="m-blue"></span></div>
      <span id="pAna" class="pct">0%</span>
    </div>

    <div class="bar" title="Avance Licenciado/a (total)">
      <span style="white-space:nowrap;color:#9fb0c2">Licenciado/a</span>
      <div class="meter"><span id="mLic" class="m-green"></span></div>
      <span id="pLic" class="pct">0%</span>
    </div>
  </div>
</details>

<footer>
  <div class="footer-inner">
    <span>© 2025 · Hecho con pasión y dedicación por</span>
    <a class="gh-link" href="https://github.com/tobiager" target="_blank" rel="noopener">
      <svg class="gh-icon" viewBox="0 0 16 16" aria-hidden="true">
        <!-- Octicon mark completo -->
        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38
        0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13
        -.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07
        -1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12
        0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82
        .44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48
        0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
      </svg>
      Tobías
    </a>
    <span>·</span>
    <a class="gh-link no-icon" href="https://github.com/tobiager/UNNE-LSI" target="_blank" rel="noopener">
      Repositorio de LSI
    </a>
  </div>
</footer>


<div id="toast" class="toast"></div>
<div id="confirm" class="confirm">
  <div class="confirm-box">
    <p id="confirm-message"></p>
    <div class="confirm-buttons">
      <button id="confirm-accept">Aceptar</button>
      <button id="confirm-cancel">Cancelar</button>
    </div>
  </div>
</div>

<script>
function responsiveMenu(){
  const isDesktop = window.innerWidth >= 700;
  const menu = document.getElementById('menu');
  const status = document.getElementById('statusbar');
  if(isDesktop){
    menu.setAttribute('open','');
    status.setAttribute('open','');
  }else{
    menu.removeAttribute('open');
    status.removeAttribute('open');
  }
}
responsiveMenu();
window.addEventListener('resize', responsiveMenu);
const savedTheme=localStorage.getItem('theme')||'theme-dark';
document.body.classList.add(savedTheme);
const STORAGE_KEY='simulador-avance';
const NAME_KEY='simulador-nombre';
let plans={}, currentPlan='', states={}, studentName='';

const ANALISTA_OVERRIDES = {};

function showToast(msg,dur=2000){
  const el=document.getElementById('toast');
  el.textContent=msg; el.classList.add('show');
  clearTimeout(window._toastTimer);
  window._toastTimer=setTimeout(()=>el.classList.remove('show'),dur);
}

function showConfirm(msg,onAccept){
  const modal=document.getElementById('confirm');
  document.getElementById('confirm-message').textContent=msg;
  modal.classList.add('show');
  const acc=document.getElementById('confirm-accept');
  const canc=document.getElementById('confirm-cancel');
  function cleanup(){
    modal.classList.remove('show');
    acc.removeEventListener('click',onA);
    canc.removeEventListener('click',onC);
  }
  function onA(){ cleanup(); onAccept&&onAccept(); }
  function onC(){ cleanup(); }
  acc.addEventListener('click',onA);
  canc.addEventListener('click',onC);
}

fetch('plans.json').then(r=>r.json()).then(data=>{
  plans=data;
  const sel=document.getElementById('plan');
  Object.entries(plans).forEach(([k,p])=>{
    const opt=document.createElement('option'); opt.value=k; opt.textContent=p.nombre||k; sel.appendChild(opt);
  });
  currentPlan = Object.keys(plans)[0]; sel.value=currentPlan;
  sel.addEventListener('change',()=>{ currentPlan=sel.value; loadStates(); render(); });
  document.getElementById('search').addEventListener('input',render);
  document.getElementById('onlyEnabled').addEventListener('change',render);
  document.getElementById('studentName').addEventListener('input',e=>{ studentName=e.target.value; saveStates(); });
  loadStates(); render();
});

function loadStates(){
  const all=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
  const raw=all[currentPlan]||{};
  states={};
  Object.entries(raw).forEach(([c,v])=>{
    if(typeof v==='object') states[c]=v;
    else states[c]={s:v,n:''};
  });
  studentName=localStorage.getItem(NAME_KEY)||'';
  document.getElementById('studentName').value=studentName;
}
function saveStates(){
  const all=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
  all[currentPlan]=states; localStorage.setItem(STORAGE_KEY,JSON.stringify(all));
  localStorage.setItem(NAME_KEY,studentName);
}
function getStatus(code){
  const v=states[code];
  return typeof v==='object'? (v.s||0) : (v||0);
}
function getNote(code){
  const v=states[code];
  return typeof v==='object'? (v.n||'') : '';
}
function setState(code,val){
  const cur=getStatus(code);
  if(val>cur){
    if(val===1 && !canCursar(code)) return;
    if(val===2 && !canRendir(code)) return;
    if(val===3 && !canCursar(code)) return;
  }
  states[code]={s:val,n:getNote(code)}; saveStates(); render();
}
function setNote(code,note){
  states[code]={s:getStatus(code),n:note};
  saveStates();
}
function getMateria(code){ return (plans[currentPlan].materias||[]).find(x=>x.codigo===code); }
function needs(list){
  return (list||[]).map(([slug,need])=>{
    const m = getMateria(slug);
    const st = getStatus(slug);
    const ok = !!m && st>=need;
    return {slug,need,exists:!!m,ok};
  });
}
function canCursar(code){ const m=getMateria(code); if(!m) return false; return needs(m.requisitos?.cursar).every(x=>x.ok); }
function canRendir(code){ const m=getMateria(code); if(!m) return false; return needs(m.requisitos?.rendir).every(x=>x.ok); }

const CUAT_LABEL = { '1':'1° Cuatrimestre', '2':'2° Cuatrimestre', 'anual':'Anual', 'extra':'Extracurricular', 'otro':'Otros' };
const CUAT_ORDER = ['1','2','anual','extra','otro'];
function cuatKey(c){
  const s = String(c).toLowerCase();
  if (s==='1' || s==='2') return s;
  if (s.includes('anual')) return 'anual';
  if (s.includes('extra')) return 'extra';
  return 'otro';
}

function render(){
  const q=(document.getElementById('search').value||'').toLowerCase();
  const only=document.getElementById('onlyEnabled').checked;
  const box=document.getElementById('materias'); box.innerHTML='';

  const grouped={};
  (plans[currentPlan].materias||[]).forEach(m=>{
    if(q && !(m.nombre.toLowerCase().includes(q))) return;
    if(only && !canCursar(m.codigo)) return;
    const key=cuatKey(m.cuatrimestre);
    if(!grouped[m.anio]) grouped[m.anio]={};
    if(!grouped[m.anio][key]) grouped[m.anio][key]=[];
    grouped[m.anio][key].push(m);
  });

  Object.keys(grouped).map(n=>+n).sort((a,b)=>a-b).forEach(anio=>{
    const y=document.createElement('section'); y.className='year';
    y.innerHTML=`<h2>${anio}° Año</h2>`;
    const grid=document.createElement('div'); grid.className='year-grid';

    CUAT_ORDER.forEach(key=>{
      const arr = grouped[anio][key]||[];
      if(!arr.length) return;
      const col=document.createElement('div'); col.className='cuat';
      const h3=document.createElement('h3'); h3.textContent=CUAT_LABEL[key]; col.appendChild(h3);

      arr.forEach(m=>{
        const s=getStatus(m.codigo);
        const reqC=needs(m.requisitos?.cursar), reqR=needs(m.requisitos?.rendir);
        const cls=['no','regular','aprobada','curso'][s];
        const card=document.createElement('div'); card.className=`card ${cls}`;

        card.innerHTML = `
          <span class="badge">${['No','Regular','Aprobada','En curso'][s]}</span>
          <h4 class="title">${m.nombre}</h4>
          <div class="sub">${m.regimen} • ${m.carga_horaria}h</div>
          <div class="meta">
            <span class="chip">Año ${m.anio}</span>
            <span class="chip">${CUAT_LABEL[key]}</span>
          </div>

          ${reqC.length?`<div class="reqs"><strong style="opacity:.8">Cursar:</strong> ${
            reqC.map(r=>`<span class="req ${!r.exists?'unknown':(r.ok?'ok':'miss')}">
              ${r.ok?'✅':'🔒'} ${prettyName(r.slug)} ${r.need===2?'(aprobar)':'(regular)'}
            </span>`).join('')}
          </div>`:''}

          ${reqR.length?`<div class="reqs"><strong style="opacity:.8">Rendir:</strong> ${
            reqR.map(r=>`<span class="req ${!r.exists?'unknown':(r.ok?'ok':'miss')}">
              ${r.ok?'✅':'🔒'} ${prettyName(r.slug)} ${r.need===2?'(aprobar)':'(regular)'}
            </span>`).join('')}
          </div>`:''}

          <div class="state">
            <button class="btn off ${s===0?'active':''}">No</button>
            <button class="btn cur ${s===3?'active':''}">Curso</button>
            <button class="btn reg ${s===1?'active':''}">Reg</button>
            <button class="btn ok ${s===2?'active':''}">Apro</button>
          </div>
          <input type="text" class="note" placeholder="Notas/fecha de examen">
        `;

        const [b0,b1,b2,b3]=card.querySelectorAll('.state .btn');
        b0.onclick=()=>setState(m.codigo,0);
        b1.onclick=()=>setState(m.codigo,3);
        b2.onclick=()=>setState(m.codigo,1);
        b3.onclick=()=>setState(m.codigo,2);

        const noteInput=card.querySelector('.note');
        noteInput.value=getNote(m.codigo);
        noteInput.addEventListener('change',e=>setNote(m.codigo,e.target.value));

        if(!canCursar(m.codigo)){ b1.disabled=true; b2.disabled=true; b3.disabled=true; }
        else if(!canRendir(m.codigo)){ b3.disabled=true; }


        col.appendChild(card);
      });

      grid.appendChild(col);
    });

    y.appendChild(grid); box.appendChild(y);
  });

  updateStats();
}

function prettyName(slug){
  const m=getMateria(slug); return m?m.nombre:slug;
}

function updateStats(){
  const arr=plans[currentPlan].materias||[];

  const counts={0:0,1:0,2:0,3:0};
  arr.forEach(m=>{counts[getStatus(m.codigo)]++;});


  document.getElementById('cAprob').textContent = counts[2];
  document.getElementById('cReg').textContent   = counts[1];
  document.getElementById('cCur').textContent   = counts[3];
  document.getElementById('cNo').textContent    = counts[0];
  document.getElementById('cTot').textContent   = arr.length;

  const anaSet = (ANALISTA_OVERRIDES[currentPlan]||[]).length
    ? new Set(ANALISTA_OVERRIDES[currentPlan])
    : new Set(arr.filter(m=>Number(m.anio)<=3).map(m=>m.codigo));
  const anaTotal = anaSet.size;
  const anaAprob = Array.from(anaSet).filter(c=> getStatus(c)===2).length;
  const anaPct = anaTotal ? Math.round(100*anaAprob/anaTotal) : 0;

  document.getElementById('mAnalista').style.width = anaPct + '%';
  document.getElementById('pAna').textContent      = anaPct + '%';

  const licTotal = arr.length;
  const licAprob = counts[2];
  const licPct   = licTotal ? Math.round(100*licAprob/licTotal) : 0;

  document.getElementById('mLic').style.width = licPct + '%';
  document.getElementById('pLic').textContent = licPct + '%';
}

const BADGE_STYLE = 'for-the-badge';

function computeLicPct(){
  const arr=plans[currentPlan].materias||[];
  const total=arr.length;
  const aprob=arr.filter(m=>getStatus(m.codigo)===2).length;
  return total? Math.round(100*aprob/total) : 0;
}
function highestFullYearApproved(){
  const arr=(plans[currentPlan].materias||[]).slice().sort((a,b)=>a.anio-b.anio);
  let max=0;
  for(let y=1;y<=5;y++){
    const all = arr.filter(m=>Number(m.anio)===y);
    if(!all.length) break;
    if(all.every(m => getStatus(m.codigo)===2)) max=y; else break;
  }
  return max;
}
function highestYearWithProgress(){
  const arr=(plans[currentPlan].materias||[]);
  let max=0;
  arr.forEach(m=>{
    const y=Number(m.anio);
    if(getStatus(m.codigo)>0 && y>max) max=y;
  });
  return max;
}
function currentShareHash(){
  const payload={ plan: currentPlan, states, name: studentName };
  const json=JSON.stringify(payload);
  return btoa(unescape(encodeURIComponent(json)));
}
function shareUrl(){
  const base = `${location.origin}${location.pathname.replace(/\/[^\/]*$/,'/')}`;
  return `${base}estado.html#${currentShareHash()}`;
}
function copyToClipboard(text){
  if (navigator.clipboard?.writeText) {
    navigator.clipboard.writeText(text).then(()=>showToast('Copiado ✅'));
  } else {
    const ta=document.createElement('textarea'); ta.value=text;
    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
    document.body.removeChild(ta); showToast('Copiado ✅');
  }
}
function colorByPct(p){
  if(p>=90) return '16a34a';
  if(p>=70) return '22c55e';
  if(p>=50) return 'f59e0b';
  if(p>=30) return 'f97316';
  return '64748b';
}
function makeYearBadgeMarkdown(){
const year = highestYearWithProgress();

  const files={
    0:'1er-año.png',
    1:'1er-año.png',
    2:'2do-año.PNG',
    3:'3er-año.PNG',
    4:'4to-año.PNG',
    5:'5to-año.PNG'
  };
  const file=files[year]||files[0];
  const imgUrl=new URL('../assets/badges/'+file,location.href).href;
  const alt=`LSI · ${year===0?'Ingresante':year+'º año'}`;
  return `[![${alt}](${imgUrl})](${shareUrl()})`;
}
function makePctBadgeMarkdown(){
  const pct = computeLicPct();
  const label = encodeURIComponent('🎓 Avance LSI');
  const msg   = encodeURIComponent(`${pct}%`);
  const color = colorByPct(pct);
  const url = `https://img.shields.io/badge/${label}-${msg}-${color}?style=${BADGE_STYLE}`;
  return `[![Avance LSI ${pct}%](${url})](${shareUrl()})`;
}
document.getElementById('share').onclick=()=>copyToClipboard(shareUrl());
document.getElementById('badgeYear').onclick=()=>copyToClipboard(makeYearBadgeMarkdown());
document.getElementById('badgePct').onclick=()=>copyToClipboard(makePctBadgeMarkdown());

document.getElementById('save').onclick=()=>{
  saveStates(); const btn=document.getElementById('save'); const t=btn.textContent;
  btn.textContent='Guardado ✓'; setTimeout(()=>btn.textContent=t,900);
};
document.getElementById('reset').onclick=()=>{
  showConfirm('¿Reiniciar estados del plan actual?', ()=>{ states={}; saveStates(); render(); });
};
document.getElementById('export').onclick=()=>{
  const data=localStorage.getItem(STORAGE_KEY)||'{}';
  const blob=new Blob([data],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='simulador.json'; a.click();
};
document.getElementById('import').onclick=()=>document.getElementById('fileInput').click();
document.getElementById('fileInput').addEventListener('change',e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{ try{ localStorage.setItem(STORAGE_KEY,ev.target.result); loadStates(); render(); }catch{ showToast('JSON inválido'); } };
  reader.readAsText(file);
});

const themeBtn=document.getElementById('themeToggle');
themeBtn.textContent=document.body.classList.contains('theme-dark')?'🌞':'🌜';
themeBtn.addEventListener('click',()=>{
  const isDark=document.body.classList.contains('theme-dark');
  const next=isDark?'theme-light':'theme-dark';
  document.body.classList.remove('theme-dark','theme-light');
  document.body.classList.add(next);
  localStorage.setItem('theme',next);
  themeBtn.textContent=isDark?'🌜':'🌞';
});

const statusBar=document.getElementById('statusbar');
function updateStatusHeight(){
  const h=statusBar.open?statusBar.offsetHeight:statusBar.querySelector('summary').offsetHeight;
  document.body.style.setProperty('--status-h',h+'px');
}
statusBar.addEventListener('toggle',updateStatusHeight);
updateStatusHeight();
</script>
</body>
</html>
