<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulador de Avance</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1625; --border:#1f2a36; --text:#e6edf3; --muted:#9fb0c2;
    --ok:#16a34a; --warn:#f59e0b; --off:#4b5563; --accent:#60a5fa;
    --card:#0f1726; --card2:#0b1423;
  }
  *{box-sizing:border-box}
  body{margin:0;color:var(--text);
       background:radial-gradient(900px 360px at -10% -10%,#10233a 0,transparent 60%),
                  radial-gradient(700px 480px at 110% -10%,#1b2a43 0,transparent 50%),
                  var(--bg);
       font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif}
  header{position:sticky;top:0;z-index:20;background:rgba(11,15,20,.7);backdrop-filter:saturate(130%) blur(8px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1180px;margin:0 auto;padding:16px}
  h1{margin:0 0 8px;font-size:1.7rem;letter-spacing:.2px}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  select,button,input[type="search"]{background:#0e1727;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:12px;font-weight:600}
  .legend{display:flex;flex-wrap:wrap;gap:12px;margin-left:auto}
  .dot{width:12px;height:12px;border-radius:999px;display:inline-block;margin-right:6px}

  main{padding:10px 0 24px}
  #materias{display:grid;grid-template-columns:repeat(2,minmax(320px,1fr));gap:14px;margin-top:16px}
  .year{grid-column:1 / -1;border:1px solid var(--border);border-radius:16px;padding:14px;background:linear-gradient(180deg,var(--card),var(--card2))}
  .year>h2{margin:4px 0 12px;font-size:1.15rem;color:#cfe1ff}
  .year-grid{display:grid;grid-template-columns:repeat(2,minmax(300px,1fr));gap:12px}
  .cuat h3{margin:0 0 8px;color:#b6c6dc;font-size:1rem}

  .card{border:1px solid var(--border);border-radius:14px;padding:12px;background:linear-gradient(180deg,#101a2b,#0b1423);transition:transform .12s ease,box-shadow .12s ease;position:relative}
  .card:hover{transform:translateY(-1px);box-shadow:0 8px 16px rgba(0,0,0,.25)}
  .title{font-weight:800;margin:0 0 2px;font-size:1.02rem}
  .sub{color:#c8d7ea;margin:0 0 6px;font-size:.85rem}
  .meta,.reqs{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .chip{background:#0b1423;border:1px solid #223147;color:#b8c5d8;padding:2px 8px;border-radius:999px;font-size:.73rem}
  .req{padding:2px 8px;border-radius:999px;font-size:.73rem;border:1px solid #294151}
  .req.ok{background:#0f2717;border-color:#1e6a39;color:#a7f3d0}
  .req.miss{background:#2a0f12;border-color:#7f1d1d;color:#fecaca}
  .req.unknown{background:#2a1f0f;border-color:#7c2d12;color:#fde68a}
  .state{display:inline-flex;gap:6px;margin-top:10px}
  .btn{border:1px solid var(--border);background:#0e1524;color:#dbe6f4;padding:4px 8px;border-radius:10px;font-size:.8rem;cursor:pointer}
  .btn.active{outline:2px solid var(--accent)}
  .btn.off{background:#30343b}
  .btn.reg{background:#5e4a16}
  .btn.ok{background:#0f3a20}

  .badge{position:absolute;top:8px;right:8px;padding:2px 8px;border-radius:999px;font-size:.72rem;font-weight:700}
  .no     {border-color:#3b414c}
  .no .badge{background:#3b414c}
  .regular{border-color:#b59f3b}
  .regular .badge{background:#b59f3b}
  .aprobada{border-color:#16a34a}
  .aprobada .badge{background:#16a34a}

  /* Barra de progreso sticky */
  .progress{
    position:sticky; bottom:0; z-index:15;
    border-top:1px solid var(--border);
    background:linear-gradient(180deg,rgba(11,15,20,.65),rgba(11,15,20,.85));
    backdrop-filter:saturate(130%) blur(8px);
    box-shadow:0 -6px 24px rgba(0,0,0,.25);
    padding:12px 16px; margin-top:24px;
  }
  .stats-compact{display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:center}
  .pbar{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center}
  .pbar .label{color:var(--muted);white-space:nowrap}
  .meter{height:10px;border-radius:999px;background:#111a29;border:1px solid var(--border);overflow:hidden}
  .meter.sm{height:8px}
  .meter>span{display:block;height:100%;width:0%}
  .m-green{background:linear-gradient(90deg,#22c55e,#16a34a)}
  .m-blue{background:linear-gradient(90deg,#60a5fa,#3b82f6)}
  .pct{min-width:3.5ch;text-align:right;color:#a7f3d0;font-weight:700}
  .small{color:var(--muted);margin-top:8px}

  .counts{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;
        border:1px solid var(--border);background:#0e1727;font-weight:700;font-size:.82rem}
  .pill.ok{border-color:#1e6a39;background:#0f2717;color:#a7f3d0}
  .pill.reg{border-color:#7c5a16;background:#2a1f0f;color:#fde68a}
  .pill.no{border-color:#3b414c;background:#0f141d;color:#cbd5e1}

  footer{border-top:1px solid var(--border);background:rgba(11,15,20,.6)}
  footer .wrap{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center}
  footer a{color:#80c0ff;text-decoration:none}
  footer a:hover{text-decoration:underline}
  .foot-left,.foot-right{padding:12px 0}
  .foot-right{opacity:.9}

  @media (max-width:900px){
    #materias{grid-template-columns:1fr}
    .year-grid{grid-template-columns:1fr}
    .stats-compact{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Simulador de Avance</h1>
    <div class="toolbar">
      <select id="plan"></select>
      <input id="search" type="search" placeholder="Buscar materia..." />
      <label><input type="checkbox" id="onlyEnabled"> Solo habilitadas</label>
      <button id="save">Guardar</button>
      <button id="reset">Reiniciar</button>
      <button id="export">Exportar JSON</button>
      <button id="import">Importar JSON</button>
      <button id="share">Link de estado</button>
      <button id="badgeYear">Copiar badge · Año</button>
      <button id="badgePct">Copiar badge · %</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
      <div class="legend">
        <span><span class="dot" style="background:#3b414c"></span>No cursada</span>
        <span><span class="dot" style="background:#b59f3b"></span>Regular</span>
        <span><span class="dot" style="background:#16a34a"></span>Aprobada</span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="materias"></div>

  <section class="progress" id="progress">
    <div class="counts" id="countChips"></div>
    <div class="stats-compact">
      <div class="pbar">
        <span class="label">Analista Programador/a</span>
        <div class="meter sm"><span id="mAnalista" class="m-blue"></span></div>
        <span id="pAna" class="pct">0%</span>
      </div>
      <div class="pbar">
        <span class="label">Licenciado/a en Sistemas</span>
        <div class="meter sm"><span id="mLic" class="m-green"></span></div>
        <span id="pLic" class="pct">0%</span>
      </div>
    </div>
    <div id="stats" class="small"></div>
    <div id="anaInfo" class="small"></div>
  </section>
</main>

<footer>
  <div class="wrap">
    <div class="foot-left">
      © <span id="yearNow"></span> Simulador de Avance — Todos los derechos reservados.
    </div>
    <div class="foot-right">
      Hecho por <a href="https://github.com/tobiager" target="_blank" rel="noopener">tobiager</a> •
      Repo: <a href="https://github.com/tobiager/UNNE-LSI" target="_blank" rel="noopener">tobiager/UNNE-LSI</a> •
      Licencia: MIT
    </div>
  </div>
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const STORAGE_KEY='simulador-avance';
  let plans={}, currentPlan='', states={};

  const ANALISTA_OVERRIDES = {};

  // Helpers seguros
  const $ = s => document.querySelector(s);
  const $id = s => document.getElementById(s);

  // UTF-8 safe base64
  function b64encode(str){
    const bytes = new TextEncoder().encode(str);
    let bin = '';
    bytes.forEach(b => bin += String.fromCharCode(b));
    return btoa(bin);
  }

  // --------- Carga de planes ----------
  fetch('plans.json').then(r=>r.json()).then(data=>{
    plans=data||{};
    const sel=$id('plan');
    sel.innerHTML='';
    Object.entries(plans).forEach(([k,p])=>{
      const opt=document.createElement('option');
      opt.value=k; opt.textContent=p?.nombre||k; sel.appendChild(opt);
    });
    currentPlan = Object.keys(plans)[0] || '';
    if (currentPlan) sel.value=currentPlan;

    sel.addEventListener('change',()=>{ currentPlan=sel.value; loadStates(); render(); });
    $id('search').addEventListener('input',render);
    $id('onlyEnabled').addEventListener('change',render);

    loadStates(); render();
  }).catch(e=>{
    console.error('Error cargando plans.json', e);
  });

  // --------- Estado ----------
  function loadStates(){
    try{
      const all=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
      states=(all&&currentPlan)?(all[currentPlan]||{}):{};
    }catch{ states={}; }
  }
  function saveStates(){
    try{
      const all=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
      all[currentPlan]=states; localStorage.setItem(STORAGE_KEY,JSON.stringify(all));
    }catch(e){ console.warn('No se pudo guardar', e); }
  }

  function getPlanMaterias(){
    return plans?.[currentPlan]?.materias || [];
  }

  function getMateria(code){
    // code puede ser string o número; normalizamos
    const mats=getPlanMaterias();
    return mats.find(x=> String(x.codigo)===String(code));
  }

  function needs(list){
    return (list||[]).map(([code,need])=>{
      const m = getMateria(code);
      const st = (m && states[m.codigo]) || 0;
      return {slug:code, need, exists:!!m, ok: !!m && st>=need};
    });
  }
  function canCursar(code){
    const m=getMateria(code); if(!m) return false;
    return needs(m.requisitos?.cursar).every(x=>x.ok);
  }
  function canRendir(code){
    const m=getMateria(code); if(!m) return false;
    return needs(m.requisitos?.rendir).every(x=>x.ok);
  }

  const CUAT_LABEL = { '1':'1° Cuatrimestre', '2':'2° Cuatrimestre', 'anual':'Anual', 'extra':'Extracurricular', 'otro':'Otros' };
  const CUAT_ORDER = ['1','2','anual','extra','otro'];
  function cuatKey(c){
    const s = String(c??'').toLowerCase();
    if (s==='1' || s==='2') return s;
    if (s.includes('anual')) return 'anual';
    if (s.includes('extra')) return 'extra';
    return 'otro';
  }

  function setState(code,val){
    const cur=states[code]||0;
    if(val>cur){
      if(val===1 && !canCursar(code)) return;
      if(val===2 && !canRendir(code)) return;
    }
    states[code]=val; saveStates(); render();
  }

  function render(){
    if(!currentPlan || !plans[currentPlan]) return;
    const q=($id('search').value||'').toLowerCase();
    const only=$id('onlyEnabled').checked;
    const box=$id('materias'); box.innerHTML='';

    const mats = getPlanMaterias();
    const grouped={};
    mats.forEach(m=>{
      if(q && !(m.nombre||'').toLowerCase().includes(q)) return;
      if(only && !canCursar(m.codigo)) return;
      const key=cuatKey(m.cuatrimestre);
      if(!grouped[m.anio]) grouped[m.anio]={};
      if(!grouped[m.anio][key]) grouped[m.anio][key]=[];
      grouped[m.anio][key].push(m);
    });

    Object.keys(grouped).map(n=>+n).sort((a,b)=>a-b).forEach(anio=>{
      const y=document.createElement('section'); y.className='year';
      y.innerHTML=`<h2>${anio}° Año</h2>`;
      const grid=document.createElement('div'); grid.className='year-grid';

      CUAT_ORDER.forEach(key=>{
        const arr = grouped[anio][key]||[];
        if(!arr.length) return;
        const col=document.createElement('div'); col.className='cuat';
        const h3=document.createElement('h3'); h3.textContent=CUAT_LABEL[key]; col.appendChild(h3);

        arr.forEach(m=>{
          const s=states[m.codigo]||0;
          const reqC=needs(m.requisitos?.cursar), reqR=needs(m.requisitos?.rendir);
          const cls=['no','regular','aprobada'][s];
          const card=document.createElement('div'); card.className=`card ${cls}`;

          card.innerHTML = `
            <span class="badge">${['No','Regular','Aprobada'][s]}</span>
            <h4 class="title">${m.nombre}</h4>
            <div class="sub">${m.regimen||''} • ${m.carga_horaria||0}h</div>
            <div class="meta">
              <span class="chip">Año ${m.anio}</span>
              <span class="chip">${CUAT_LABEL[key]}</span>
            </div>

            ${reqC.length?`<div class="reqs"><strong style="opacity:.8">Cursar:</strong> ${
              reqC.map(r=>`<span class="req ${!r.exists?'unknown':(r.ok?'ok':'miss')}">
                ${r.ok?'✅':'🔒'} ${prettyName(r.slug)} ${r.need===2?'(aprobar)':'(regular)'}
              </span>`).join('')}
            </div>`:''}

            ${reqR.length?`<div class="reqs"><strong style="opacity:.8">Rendir:</strong> ${
              reqR.map(r=>`<span class="req ${!r.exists?'unknown':(r.ok?'ok':'miss')}">
                ${r.ok?'✅':'🔒'} ${prettyName(r.slug)} ${r.need===2?'(aprobar)':'(regular)'}
              </span>`).join('')}
            </div>`:''}

            <div class="state">
              <button class="btn off ${s===0?'active':''}">No</button>
              <button class="btn reg ${s===1?'active':''}">Reg</button>
              <button class="btn ok ${s===2?'active':''}">Apro</button>
            </div>
          `;

          const [b0,b1,b2]=card.querySelectorAll('.state .btn');
          b0.onclick=()=>setState(m.codigo,0);
          b1.onclick=()=>setState(m.codigo,1);
          b2.onclick=()=>setState(m.codigo,2);

          if(!canCursar(m.codigo)){ b1.disabled=true; b2.disabled=true; }
          else if(!canRendir(m.codigo)){ b2.disabled=true; }

          col.appendChild(card);
        });

        grid.appendChild(col);
      });

      y.appendChild(grid); box.appendChild(y);
    });

    updateStats();
  }

  function prettyName(code){
    const m=getMateria(code); return m?m.nombre:String(code);
  }

  function updateStats(){
    const arr=getPlanMaterias();
    const counts={0:0,1:0,2:0};
    arr.forEach(m=>{counts[states[m.codigo]||0]++;});

    $id('countChips').innerHTML = `
      <span class="pill ok">✅ Aprobadas: ${counts[2]}</span>
      <span class="pill reg">🟡 Regulares: ${counts[1]}</span>
      <span class="pill no">⚫ No cursadas: ${counts[0]}</span>
      <span class="pill">📚 Total: ${arr.length}</span>
    `;
    $id('stats').textContent =
      `Aprobadas: ${counts[2]} | Regulares: ${counts[1]} | No cursadas: ${counts[0]} | Total: ${arr.length}`;

    const anaArr = arr.filter(m => Number(m.anio) <= 3);
    const anaTotal = anaArr.length;
    const anaAprob = anaArr.filter(m => (states[m.codigo]||0) === 2).length;
    const anaPct = anaTotal ? Math.round(100 * anaAprob / anaTotal) : 0;
    $id('mAnalista').style.width = anaPct + '%';
    $id('pAna').textContent = anaPct + '%';

    const anaMissing = anaArr.filter(m => (states[m.codigo]||0) !== 2);
    $id('anaInfo').textContent =
      anaMissing.length===0
        ? `Analista: ${anaAprob}/${anaTotal} (${anaPct}%) • ✅ ¡Completado!`
        : `Analista: ${anaAprob}/${anaTotal} (${anaPct}%) • Te faltan ${anaMissing.length}: ${anaMissing.map(m=>m.nombre).join(', ')}`;

    const licTotal = arr.length;
    const licAprob = counts[2];
    const licPct = licTotal ? Math.round(100 * licAprob / licTotal) : 0;
    $id('mLic').style.width = licPct + '%';
    $id('pLic').textContent = licPct + '%';
  }

  // ====== Badges + Estado ======
  const BADGE_STYLE = 'for-the-badge';
  function computeLicPct(){
    const arr=getPlanMaterias();
    const total=arr.length;
    const aprob=arr.filter(m=>(states[m.codigo]||0)===2).length;
    return total? Math.round(100*aprob/total) : 0;
  }
  function highestFullYearApproved(){
    const arr=getPlanMaterias().slice().sort((a,b)=>a.anio-b.anio);
    let max=0;
    for(let y=1;y<=6;y++){
      const all = arr.filter(m=>Number(m.anio)===y);
      if(!all.length) break;
      if(all.every(m => (states[m.codigo]||0)===2)) max=y; else break;
    }
    return max;
  }
  function currentShareHash(){
    const payload={ plan: currentPlan, states };
    return b64encode(JSON.stringify(payload));
  }
  function shareUrl(){
    const base = `${location.origin}${location.pathname.replace(/\/[^\/]*$/,'/')}`;
    return `${base}estado.html#${currentShareHash()}`;
  }
  function copyToClipboard(text){
    if (navigator.clipboard?.writeText) {
      navigator.clipboard.writeText(text).then(()=>alert('Copiado ✅'));
    } else {
      const ta=document.createElement('textarea'); ta.value=text;
      document.body.appendChild(ta); ta.select(); document.execCommand('copy');
      document.body.removeChild(ta); alert('Copiado ✅');
    }
  }
  function colorByPct(p){
    if(p>=90) return '16a34a';
    if(p>=70) return '22c55e';
    if(p>=50) return 'f59e0b';
    if(p>=30) return 'f97316';
    return '64748b';
  }
  function makeYearBadgeMarkdown(){
    const year = highestFullYearApproved();
    const label = encodeURIComponent('🎓 LSI');
    const msg   = encodeURIComponent( year===0 ? 'Ingresante' : `${year}º año` );
    const color = '16a34a';
    const url = `https://img.shields.io/badge/${label}-${msg}-${color}?style=${BADGE_STYLE}`;
    return `[![LSI · ${year===0?'Ingresante':year+'º año'}](${url})](${shareUrl()})`;
  }
  function makePctBadgeMarkdown(){
    const pct = computeLicPct();
    const label = encodeURIComponent('🎓 Avance LSI');
    const msg   = encodeURIComponent(`${pct}%`);
    const color = colorByPct(pct);
    const url = `https://img.shields.io/badge/${label}-${msg}-${color}?style=${BADGE_STYLE}`;
    return `[![Avance LSI ${pct}%](${url})](${shareUrl()})`;
  }

  // Listeners
  $id('yearNow').textContent = new Date().getFullYear();
  $id('share').onclick=()=>copyToClipboard(shareUrl());
  $id('badgeYear').onclick=()=>copyToClipboard(makeYearBadgeMarkdown());
  $id('badgePct').onclick=()=>copyToClipboard(makePctBadgeMarkdown());
  $id('save').onclick=()=>{ saveStates(); const btn=$id('save'); const t=btn.textContent; btn.textContent='Guardado ✓'; setTimeout(()=>btn.textContent=t,900); };
  $id('reset').onclick=()=>{ if(confirm('¿Reiniciar estados del plan actual?')){ states={}; saveStates(); render(); } };
  $id('export').onclick=()=>{ const data=localStorage.getItem(STORAGE_KEY)||'{}'; const blob=new Blob([data],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='simulador.json'; a.click(); };
  $id('import').onclick=()=> $id('fileInput').click();
  $id('fileInput').addEventListener('change',e=>{
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=ev=>{ try{ localStorage.setItem(STORAGE_KEY,ev.target.result); loadStates(); render(); }catch{ alert('JSON inválido'); } };
    reader.readAsText(file);
  });
});
</script>
</body>
</html>

